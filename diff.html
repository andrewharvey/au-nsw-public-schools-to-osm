<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://unpkg.com/lodash@4.17.5/lodash.min.js'></script>
    <script src='https://unpkg.com/d3-fetch@1.1.0/dist/d3-fetch.min.js'></script>
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <script src='querystring.js'></script>
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }

        tr:nth-child(odd) {
            background-color: #eee
        }
        tr:nth-child(even) {
            background-color: #ddd;
        }

        .modify {
            background-color: orange;
        }
        .add {
            background-color: lightgreen;
        }
        .row {
            margin: 10px;
            border-width: 1px;
            border-color: black;
            border-style: solid;
        }
    </style>
</head>
<body>
    <div id="content"></div>
<script>
    Promise.all([
        d3.json('matches.json'),
        d3.json('osm-schools.geojson'),
        d3.json('nsw-public-schools.geojson')
    ])
    .then(([matches, osm, upstream]) => {
        //var currentMatch = 1;
        //var pageNumber = document.createElement('span');
        //pageNumber.textContent = `${currentMatch} of ${Object.keys(matches).length}`;
        //document.getElementById('content').appendChild(pageNumber);

        // ensure osm features have an ID for indexing
        osm.features = osm.features.map((feature, index) => {
            if (!feature.id)
                feature.id = index;
            return feature;
        });
        // ensure upstream features have an ID for indexing
        upstream.features = upstream.features.map((feature, index) => {
            if (!feature.id)
                feature.id = index;
            return feature;
        });

        // osm and upstream features indexed by ID
        const osmFeatures = {};
        turf.featureEach(osm, (feature) => {
            osmFeatures[feature.id] = feature;
        });

        const upstreamFeatures = {};
        turf.featureEach(upstream, (feature) => {
            upstreamFeatures[feature.id] = feature;
        });

        // for each match...
        Object.keys(matches).map((key, index) => {
            var title = index;

            var table = document.createElement('table');

            // table header
            var tr = document.createElement('tr');

            // tag
            var th = document.createElement('th');
            th.textContent = 'Tag';
            tr.appendChild(th);

            // upstream
            var th = document.createElement('th');
            th.textContent = 'Upstream'
            tr.appendChild(th);

            // OSM features
            matches[key].map((match) => {
                var th = document.createElement('th');

                var a = document.createElement('a');
                a.setAttribute('href', 'https://www.openstreetmap.org/' + match);
                a.textContent = match;

                th.appendChild(a);

                // add a checkbox so users can choose which one the tags should be applied to
                if (matches[key].length > 1) {
                    var input = document.createElement('input');
                    input.setAttribute('type', 'checkbox');
                    th.appendChild(input);
                }

                tr.appendChild(th);
            });
            table.appendChild(tr);

            var modifyTags = [];
            Object.keys(upstreamFeatures[key].properties).map((tag) => {
                var tr = document.createElement('tr');

                var td = document.createElement('td');
                td.textContent = tag;
                tr.appendChild(td);
                
                var td0 = document.createElement('td');
                var upstreamValue = upstreamFeatures[key].properties[tag];
                td0.textContent = upstreamValue;
                tr.appendChild(td0);


                matches[key].map((match) => {
                    var td = document.createElement('td');
                    var osmValue = osmFeatures[match].properties[tag];
                    td.textContent = osmValue;

                    if (upstreamValue !== osmValue) {
                        if (upstreamValue && osmValue) {
                            td0.classList.add('modify');
                            td.classList.add('modify');
                            modifyTags.push(tag);
                        } else if (upstreamValue) {
                            td0.classList.add('add');
                        }
                    }

                    tr.appendChild(td);
                });
                table.appendChild(tr);
            });

            if (matches[key].length === 0) {
                // new feature not found in OSM
                title += ': No Match';
            } else if (matches[key].length === 1) {
                // matched to exactly 1 OSM object
                title += ': Single Match';
            } else {
                // multiple matches to OSM
                title += ': Multiple Match';
            };
            var uniqModifyTags = _.uniq(modifyTags);
            if (uniqModifyTags.length === 0) {
                title += ', insert only';
            } else {
                title += ', modify';
                if (_.without(uniqModifyTags, 'source').length === 0) {
                    title += ' (source only)';
                }
            }


            var row = document.createElement('div');
            row.classList.add('row');
            var h2 = document.createElement('h2');
            h2.textContent = title;
            row.appendChild(h2);

            var editInID = document.createElement('a');

            var params = {
                source: 'NSW CESE Public Schools Master Dataset',
                'source:url': 'https://data.cese.nsw.gov.au/data/dataset/nsw-public-schools-master-dataset',
                comment: 'importing NSW Public Schools data',
                'import:url': 'https://github.com/andrewharvey/au-nsw-public-schools-to-osm'
            };
            if (matches[key].length === 1) {
                params.id = gid(matches[key][0]);
            } else {
                params.lon = upstreamFeatures[key].geometry.coordinates[0];
                params.lat = upstreamFeatures[key].geometry.coordinates[1];
                params.zoom = 15;
            }
            editInID.setAttribute('href', 'http://www.openstreetmap.org/edit?editor=id#' + querystring.stringify(params));
            editInID.textContent = 'Edit in iD';

            row.appendChild(editInID);

            var editInJOSM = document.createElement('a');
            var josmParams = {};
            if (matches[key].length === 0) {
                josmParams.lon = upstreamFeatures[key].geometry.coordinates[0];
                josmParams.lat = upstreamFeatures[key].geometry.coordinates[1];
                josmOperation = 'add_node';
            } else if (matches[key].length === 1) {
                josmParams.objects = gid(matches[key][0]);
                josmParams.relation_members = 'true';
                josmOperation = 'load_object';
            }
            if (matches[key].length < 2) {
                josmParams.addtags = asTags(upstreamFeatures[key].properties);
                editInJOSM.setAttribute('href', 'http://127.0.0.1:8111/' + josmOperation + '?' + querystring.stringify(josmParams));
                editInJOSM.textContent = 'Edit in JOSM';
                row.appendChild(editInJOSM);
            }

            row.appendChild(table);

            var addToJOSM = document.createElement('button');
            addToJOSM.textContent = 'Add to JOSM';

            addToJOSM.addEventListener('click', (e) => {
                d3.text('http://127.0.0.1:8111/' + josmOperation + '?' + querystring.stringify(josmParams)).then((response) => {
                    if (response.startsWith('OK')) {
                        addToJOSM.textContent = '✔ Add to JOSM';
                    } else {
                        addToJOSM.textContent = '❗Add to JOSM';
                    }
                });
            });
            row.appendChild(addToJOSM);
            document.getElementById('content').appendChild(row);
        });
    });

function gid(id) {
    var parts = id.split('/');
    return parts[0].charAt(0) + parts[1];
}

function asTags(properties) {
    return Object.keys(properties).map((property) => {
        return property + '=' + properties[property];
    }).join('|');
}
</script>
</body>
</html>
